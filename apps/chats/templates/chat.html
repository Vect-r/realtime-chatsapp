{% extends "base.html" %}
{% block title %}Chats{% endblock %}

{% block content %}
<div class="w-full h-[calc(100vh-80px)] flex overflow-hidden">

    <!-- Sidebar -->
    <div class="w-1/3 max-w-sm bg-white/10 backdrop-blur-lg border-r border-white/20 flex flex-col">
        <div class="p-4 border-b border-white/20">
            <h2 class="text-xl font-semibold">Chats</h2>
        </div>

        <!-- User List -->
        <div class="flex-1 overflow-y-auto">
            {% for conversation in conversations %}
            {%if conversation.user1.id != request.authenticated_user.id%}
            <a href="{% url 'userChats' conversation.user1.id %}">
            <div class="flex items-center gap-3 px-4 py-3 hover:bg-white/10 cursor-pointer transition">
                <div class="w-10 h-10 rounded-full bg-indigo-500 flex items-center justify-center font-bold">
                    {{ conversation.user1.username|slice:":1"|upper }}
                </div>
                <div>
                    <p class="font-semibold">{{ conversation.user1.username }}</p>
                    <p class="text-xs text-white/60">Tap to chat</p>
                </div>
            </div>
            </a>
            {%else%}
            <a href="{% url 'userChats' conversation.user2.id %}">
            <div class="flex items-center gap-3 px-4 py-3 hover:bg-white/10 cursor-pointer transition">
                <div class="w-10 h-10 rounded-full bg-indigo-500 flex items-center justify-center font-bold">
                    {{ conversation.user2.username|slice:":1"|upper }}
                </div>
                <div>
                    <p class="font-semibold">{{ conversation.user2.username }}</p>
                    <p class="text-xs text-white/60">Tap to chat</p>
                </div>
            </div>
            </a>
            {%endif%}

            {% empty %}
            <p class="p-4 text-white/60">No users available</p>
            {% endfor %}
        </div>
    </div>

    <!-- Chat Panel -->
    <div class="flex-1 flex flex-col bg-white/5 backdrop-blur-md">

        <!-- Chat Header -->
         {%if selected_user%}
        <div class="p-4 border-b border-white/20 flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-indigo-500 flex items-center justify-center font-bold">
                U
            </div>
            <div>
                <p class="font-semibold">{{selected_user.username}}</p>
                <p class="text-xs text-green-300">Online</p>
            </div>
        </div>
        {%endif%}

        <!-- Messages -->
        <div class="flex-1 overflow-y-auto p-6 space-y-3" id="chat_messages">
            {% for msg in chat_messages %}
                {% include 'chat-pills.html' %}
            {% empty %}
            <p class="text-center text-white/60 mt-10">Start the conversation ðŸ‘‹</p>
            {% endfor %}
        </div>

        <!-- Input -->
        {% if selected_user%}
        <div class="p-4 border-t border-white/20 bg-white/10">
            <form id="chat_message_form" class="flex gap-3" 
                hx-ext="ws"
                ws-connect="/ws/chats/{{selected_user.id}}"
                ws-send
                _="on htmx:wsAfterSend reset() me">
                {% csrf_token %}
                {{form.content}}
                <!-- <input type="text" name="message" placeholder="Type a message..."
                       class="flex-1 px-4 py-2 rounded-xl bg-white/20 border border-white/20 
                              placeholder-white/60 focus:ring-2 focus:ring-indigo-400 outline-none"> -->

                <button type="submit"
                        class="bg-indigo-500 hover:bg-indigo-600 px-6 py-2 rounded-xl font-semibold shadow-lg">
                    Send
                </button>
            </form>
        </div>
        {%endif%}

    </div>
</div>

{% block javascript%}
<script>
function scrollChatToBottom() {
    const container = document.getElementById("chat_messages");
    if (container) {
        container.scrollTop = container.scrollHeight;
    }
}

// Scroll after sending message
document.body.addEventListener("htmx:wsAfterSend", scrollChatToBottom);

// Scroll after receiving message via websocket
document.body.addEventListener("htmx:wsAfterMessage", scrollChatToBottom);
</script>
{%endblock%}

{% endblock %}
